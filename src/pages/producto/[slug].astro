---
import Layout from "../../layouts/Layout.astro";
import { getCollection, getEntry } from "astro:content";
import { ArrowLeft } from "lucide-astro";
import { Image } from "astro:assets";

// Importar todas las imágenes disponibles en assets
// (más escalable que importar una por una)
const images = await Astro.glob(
  "../../assets/images/**/*.{jpg,png,jpeg,gif,webp}"
);

export async function getStaticPaths() {
  const productos = await getCollection("productos");

  return productos.map((producto) => ({
    params: { slug: producto.slug },
    props: { slug: producto.slug },
  }));
}

const { slug } = Astro.params;
const productoEntry = await getEntry("productos", slug);

if (!productoEntry) {
  throw new Error("Producto no encontrado");
}

const { data, body } = productoEntry;

// Obtener el nombre del archivo de la ruta original
const fileName = data.imagen.split("/").pop();

// Crear una función para encontrar la imagen correspondiente
function findImageByName(name: string | undefined) {
  if (!name) return null;

  // Buscar imágenes que contengan el nombre del archivo en su ruta
  return (
    images.find(
      (img) => img.default && img.default.src && img.default.src.includes(name)
    )?.default || null
  );
}

// Intentar encontrar la imagen en los assets
const imageAsset = findImageByName(fileName);
---

<Layout>
  <div class="container mx-auto px-6 py-4">
    <a
      href="/productos"
      class="text-pink-400 hover:text-pink-600 inline-flex items-center"
    >
      <ArrowLeft class="h-5 w-5 mr-1" />
      Volver a todos los productos
    </a>
  </div>

  <section class="max-w-5xl mx-auto py-16 px-6 grid md:grid-cols-2 gap-12">
    {
      imageAsset ? (
        <Image
          src={imageAsset}
          width={800}
          height={600}
          alt={data.nombre}
          format="webp"
          quality={80}
          class="w-full h-auto rounded-lg shadow-md object-cover"
        />
      ) : (
        <img
          src={data.imagen}
          alt={data.nombre}
          width="800"
          height="600"
          class="w-full h-auto rounded-lg shadow-md"
        />
      )
    }
    <div>
      <h1 class="text-3xl font-serif mb-4">{data.nombre}</h1>
      <p class="text-pink-500 text-xl font-bold mb-4">€{data.precio}</p>

      <article class="mb-6 text-gray-700">
        <astro:markdown>{body}</astro:markdown>
      </article>

      <h2 class="font-semibold mb-2">Flores utilizadas:</h2>
      <ul class="mb-6 list-disc list-inside text-gray-600">
        {data.flores.map((flor) => <li>{flor}</li>)}
      </ul>

      <button
        class="bg-pink-400 text-white px-6 py-3 rounded-full hover:bg-pink-500 transition"
      >
        Añadir al carrito
      </button>
    </div>
  </section>
</Layout>
